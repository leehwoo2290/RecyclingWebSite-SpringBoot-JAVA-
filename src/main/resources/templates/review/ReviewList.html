<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<head>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div layout:fragment="content">
    <div class="itemForm-body">
        <div class="form-container">

            <!-- 평균 별점 표시 영역 -->
            <div style="margin-bottom:20px; text-align:center;">
                <h2>상품 평균 별점</h2>
                <p id="averageRating"></p>
            </div>

            <div class="cool">
                <h1>리뷰 목록</h1>
                <div class="form-card" id="reviewListContainer">
                    <!-- 리뷰 아이템들이 JS로 채워짐 -->
                </div>
            </div>

        </div>
    </div>
</div>

<script th:inline="javascript">
    const itemId = /*[[${orderedItem.id}]]*/ 0;

    // 평균 별점 업데이트
    async function updateAverageRating() {
        try {
            const response = await fetch(`/reviews/item/${itemId}/average-rating`);
            if (!response.ok) throw new Error("평균 별점 불러오기 실패");

            const avg = await response.json();
            const rounded = Math.round(avg);

            let starsHtml = '';
            for (let i = 0; i < 5; i++) {
                starsHtml += i < rounded ? '<span style="color:gold;">★</span>' : '<span style="color:lightgray;">★</span>';
            }
            document.getElementById("averageRating").innerHTML = starsHtml + ` (${avg.toFixed(1)} / 5)`;
        } catch (err) {
            document.getElementById("averageRating").innerText = "별점 불러오기 오류";
            console.error(err);
        }
    }

    // 리뷰 리스트에 새 리뷰 추가
    function addReviewToList(review) {
        const container = document.getElementById("reviewListContainer");

        const div = document.createElement('div');
        div.className = "review-card";
        div.style.border = "1px solid #ddd";
        div.style.padding = "10px";
        div.style.marginBottom = "10px";
        div.style.borderRadius = "4px";

        const stars = "★".repeat(review.rating) + "☆".repeat(5 - review.rating);

        let imagesHtml = '';
        if (review.images && review.images.length > 0) {
            imagesHtml = '<div style="margin-top:5px; display:flex; flex-wrap:wrap;">';
            review.images.forEach(imgUrl => {
                if (imgUrl) {
                    imagesHtml += `<img src="${imgUrl}" style="max-width:100px; max-height:100px; margin:5px; border:1px solid #ddd; border-radius:4px; object-fit:cover;">`;
                }
            });
            imagesHtml += '</div>';
        }

        div.innerHTML = `
            <p><strong>회원:</strong> ${review.memberId || '알 수 없음'}</p>
            <p><strong>평점:</strong> <span style="color:gold;">${stars}</span></p>
            <p><strong>내용:</strong> ${review.content || '-'}</p>
            <p><strong>구매 인증:</strong> ${review.verifiedPurchase ? '구매함' : '구매 안함'}</p>
            ${imagesHtml}
        `;

        // 리스트 최상단에 새 리뷰 추가
        container.insertBefore(div, container.firstChild);
    }

    // 초기 리뷰 목록 로딩
    async function loadReviews() {
        try {
            const response = await fetch(`/reviews/item/${itemId}/list`);
            if (!response.ok) throw new Error("리뷰 불러오기 실패");

            const reviews = await response.json();
            const container = document.getElementById("reviewListContainer");
            container.innerHTML = '';

            if (!reviews || reviews.length === 0) {
                container.innerHTML = "<p style='text-align:center;'>등록된 리뷰가 없습니다.</p>";
                return;
            }

            reviews.forEach(addReviewToList);
        } catch (err) {
            document.getElementById("reviewListContainer").innerText = "리뷰 불러오기 오류:\n" + err.message;
            console.error(err);
        }
    }

    // 리뷰 등록
    async function submitReview() {
        const ratingInput = document.getElementById('ratingInput');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('reviewForm');

        if (!submitBtn || !ratingInput || !form) return alert('페이지 요소 로드 오류');

        const rating = parseInt(ratingInput.value);
        if (rating < 1 || rating > 5) return alert('평점을 1점에서 5점 사이로 선택해주세요.');

        const formData = new FormData(form);
        const content = formData.get('content')?.trim();
        if (!content) return alert('리뷰 내용을 입력해주세요.');

        try {
            submitBtn.disabled = true;
            submitBtn.textContent = '등록 중...';

            const csrfTokenElement = document.querySelector('meta[name="_csrf"]');
            const csrfHeaderElement = document.querySelector('meta[name="_csrf_header"]');

            const headers = {};
            if (csrfTokenElement && csrfHeaderElement) {
                headers[csrfHeaderElement.getAttribute('content')] = csrfTokenElement.getAttribute('content');
            }

            const response = await fetch('/reviews', {
                method: 'POST',
                headers: headers,
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`서버 오류: ${response.status} - ${errorText}`);
            }

            const newReview = await response.json();

            // 새 리뷰를 리스트에 추가
            addReviewToList(newReview);
            // 평균 별점 갱신
            updateAverageRating();

            alert('리뷰가 성공적으로 등록되었습니다!');
            form.reset();
            document.getElementById('preview').innerHTML = '';

        } catch (err) {
            console.error('리뷰 등록 에러:', err);
            alert('리뷰 등록 중 오류가 발생했습니다: ' + err.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '리뷰 등록';
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        updateAverageRating();
        loadReviews();
    });
</script>



<style>
    /* 별점 스타일 */
    .stars { display: flex; gap: 5px; font-size: 1.5rem; cursor: pointer; }
    .star { color: lightgray; }
    .star.selected { color: gold; }
</style>

</body>
</html>
