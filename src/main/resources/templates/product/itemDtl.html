<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<meta charset="UTF-8">

<head>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div layout:fragment="content">

    <div class="card-body">

        <br><br>
        <div class="category mb-3 center-content">
            <h2>ë°”ë””ì¼€ì–´</h2>
            <hr>
            <nav class="item-category-nav">
                <a href="#">ë¡œì…˜ë°”</a> |
                <a href="#">í•¸ë“œì¼€ì–´ë°”</a> |
                <a href="#">í’‹ì¼€ì–´ë°”</a> |
                <a href="#">ë¦½ë°¤</a> |
                <a href="#">ë°ì˜¤ë“œë€íŠ¸ë°”</a> |
                <a href="#">ë§ˆì‚¬ì§€ë°”</a> |
                <a href="#">ì„ ì¼€ì–´</a>
            </nav>
        </div>

        <input type="hidden" id="itemId" th:value="${item.id}">
        <input type="hidden" id="price" th:value="${item.price}">

        <div class="product-detail">
            <div class="repImgDiv">
                <img th:if="${item.repImgUrl != null}"
                     th:src="${item.repImgUrl}"
                     th:alt="${item.itemNm}"
                     class="repImg"
                     style="width:500px; height:500px;
                         object-fit:cover; justify-content: center;">
            </div>

            <div class="product-info">
                <br>
                <br>
                <div class="h4" th:text="${item.itemNm}"></div>

                <div class="wd50 flex-grow-1">
                    <span th:if="${item.itemSellStatus.name() == 'SELL'}" class="badge badge-primary mb-3">
            íŒë§¤ì¤‘
        </span>
                    <span th:unless="${item.itemSellStatus.name() == 'SELL'}" class="badge btn-danger mb-3">
            í’ˆì ˆ
        </span>

                    <div class="h5">
                        <span th:text="${item.price}"></span>ì›
                    </div>
                    <hr class="custom-hr">

                    <div class="mb-3">
                        <span>ğŸ‘ï¸ ì¡°íšŒ ìˆ˜: <span th:text="${item.views}">0</span></span>
                        <span class="ms-3">â¤ï¸ ì¢‹ì•„ìš”: <span id="like-count" th:text="${item.likes}">0</span></span>
                    </div>

                    <button type="button" class="btn-submit mb-3" th:onclick="addLike([[${item.id}]])">
                        â™¥ ì¢‹ì•„ìš”
                    </button>
                    <br><br>

                    <!-- ğŸ’¡ ì¶”ê°€: ê´€ë¦¬ì ì „ìš© ë²„íŠ¼ -->
                    <div id="adminButtons" style="display:none; margin-bottom: 20px;">
                        <button type="button" class="btn-submit" onclick="goToEdit()">ìƒí’ˆ ìˆ˜ì •</button>
                        <button type="button" class="btn-submit" onclick="deleteItemFromDetail()" style="background-color: #dc3545;">ìƒí’ˆ ì‚­ì œ</button>
                    </div>

                    <div class="input-group w-50 mb-4">
                        <div class="input-group-prepend">
                            <span class="input-group-text">ìˆ˜ëŸ‰</span>
                            <input type="number" id="count" class="form-control" value="1" min="1">
                        </div>
                    </div>
                    <br>

                    <hr class="custom-hr">
                    <div class="text-right mb-4">
                        <h5>ê²°ì œ ê¸ˆì•¡</h5>
                        <h3 id="totalPrice" class="font-weight-bold"></h3>
                    </div>

                    <div th:if="${item.itemSellStatus.name() == 'SELL'}" class="text-right mb-3">
                        <button type="button" class="btn-submit me-2" onclick="addToCart()">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                        <button type="button" class="btn-submit" onclick="order()">ì£¼ë¬¸í•˜ê¸°</button>
                    </div>
                    <div th:unless="${item.itemSellStatus.name() == 'SELL'}" class="text-right mb-3">
                        <button type="button" class="btn btn-danger btn-lg">í’ˆì ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr class="custom-hr">
    <h4>ìƒí’ˆ ì„¤ëª…</h4>

    <div th:each="fileName : ${item.fileNames}" class="text-center">
        <img th:if="${fileName != null and fileName != ''}"
             th:src="${fileName}"
             class="rounded mgb-15" width="800">
    </div>

    <hr class="custom-hr">

    <div class="review-section">
        <h3>ìƒí’ˆ ë¦¬ë·° <span id="review-total-count" class="text-muted">(0)</span></h3><br>

        <div class="review-list">
            <div id="reviews-container">
            </div>

            <div class="pagination-container text-center mt-4">
                <nav>
                    <ul class="pagination justify-content-center" id="review-pagination">
                    </ul>
                </nav>
            </div>
            <br><br>
        </div>
    </div>

</div>


<div layout:fragment="script">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <!-- &lt;!&ndash; ğŸ’¡ ì¶”ê°€: tokenManager.js ë¡œë“œ &ndash;&gt; -->
    <script th:src="@{/js/tokenManager.js}"></script>

    <script th:inline="javascript">
        let currentPage = 1;
        const pageSize = 5;

        $(document).ready(function(){
            calculateTotalPrice();
            loadReviews();
            $("#count").on('input change', calculateTotalPrice);

            // ğŸ’¡ ì¶”ê°€: ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
            checkAdminAuth();
        });

      /*  // ğŸ’¡ ì¶”ê°€: ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ í•¨ìˆ˜
        async function checkAdminAuth() {
            const itemId = $("#itemId").val();
            const res = await tokenManager.fetchWithToken(`/admin/item/${itemId}/check`);

            if (res.ok) {
                // ğŸ’¡ ê¶Œí•œì´ ìˆìœ¼ë©´ ê´€ë¦¬ì ë²„íŠ¼ í‘œì‹œ
                document.getElementById('adminButtons').style.display = 'block';
            }
        }

        // ğŸ’¡ ì¶”ê°€: ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
        function goToEdit() {
            const itemId = $("#itemId").val();
            window.location.href = `/admin/item/${itemId}`;
        }

        // ğŸ’¡ ì¶”ê°€: ìƒí’ˆ ì‚­ì œ í•¨ìˆ˜
        async function deleteItemFromDetail() {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            const itemId = $("#itemId").val();

            // ğŸ’¡ ê¶Œí•œ ì²´í¬ ì¶”ê°€
            const checkRes = await tokenManager.fetchWithToken(`/admin/item/${itemId}/check`);
            if (!checkRes.ok) {
                if (checkRes.status === 401) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "/members/login";
                } else if (checkRes.status === 403) {
                    alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                }
                return;
            }

            // ğŸ’¡ ê¶Œí•œ í™•ì¸ í›„ ì‚­ì œ ì§„í–‰
           /!* fetch('/admin/items', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'itemIds=' + itemId
            })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                    window.location.href = '/products';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });*!/
            // ğŸ’¡ ìˆ˜ì •: tokenManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ í† í° í¬í•¨
            try {
                const res = await tokenManager.fetchWithToken('/admin/items', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'itemIds=' + itemId
                });

                const data = await res.text();

                if (res.ok) {
                    alert(data);
                    window.location.href = '/products';
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }*/

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        async function checkAdminAuth() {
            try {
                const itemId = $("#itemId").val();
                const res = await tokenManager.fetchWithToken(`/admin/item/${itemId}/check`);
                if (res.ok) {
                    document.getElementById('adminButtons').style.display = 'block';
                }
            } catch (error) {
                console.error('ê¶Œí•œ ì²´í¬ ì˜¤ë¥˜:', error);
            }
        }

        // ìƒí’ˆ ìˆ˜ì • í˜ì´ì§€ ì´ë™
        function goToEdit() {
            const itemId = $("#itemId").val();
            window.location.href = `/admin/item/${itemId}`;
        }

        // ìƒí’ˆ ì‚­ì œ
        async function deleteItemFromDetail() {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            const itemId = $("#itemId").val();

            try {
                const checkRes = await tokenManager.fetchWithToken(`/admin/item/${itemId}/check`);
                if (!checkRes.ok) {
                    if (checkRes.status === 401) {
                        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        window.location.href = "/members/login";
                    } else if (checkRes.status === 403) {
                        alert("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    return;
                }

                const deleteRes = await tokenManager.fetchWithToken('/admin/items', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'itemIds=' + itemId
                });

                const data = await deleteRes.text();
                if (deleteRes.ok) {
                    alert(data);
                    window.location.href = '/products';
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data);
                }
            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }



        function calculateTotalPrice(){
            var count = parseInt($("#count").val()) || 1;
            var price = parseInt($("#price").val()) || 0;

            if(count < 1) {
                count = 1;
                $("#count").val(1);
            }

            var totalPrice = price * count;
            $("#totalPrice").html(totalPrice.toLocaleString() + 'ì›');
        }

        async function loadReviews(page = 1) {
            const itemId = $("#itemId").val();

            try {
                const response = await fetch(`/api/items/${itemId}/reviews?page=${page}&size=${pageSize}`);

                console.log(`ğŸ” ë¦¬ë·° ëª©ë¡ ìš”ì²­: /api/items/${itemId}/reviews?page=${page}&size=${pageSize}`);
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“¦ ë°›ì€ ë°ì´í„°:', data);

                    displayReviews(data.reviews);
                    displayPagination(data.totalPages, page);
                    updateReviewCount(data.totalElements);
                } else {
                    console.error('âŒ ë¦¬ë·° ë¡œë“œ ì‹¤íŒ¨ - ìƒíƒœ:', response.status);
                    const errorText = await response.text();
                    console.error('âŒ ì—ëŸ¬ ë‚´ìš©:', errorText);
                    displayNoReviews();
                }
            } catch (error) {
                console.error('âŒ ë¦¬ë·° ë¡œë“œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                displayNoReviews();
            }
        }

        function displayReviews(reviews) {
            const container = $('#reviews-container');

            if (!reviews || reviews.length === 0) {
                displayNoReviews();
                return;
            }

            let html = '';
            reviews.forEach(review => {
                html += `
                    <div class="review-item">
                        <div class="review-header">
                            <div>
                                <span class="review-author">${escapeHtml(review.memberName || review.memberId || 'ìµëª…')}</span>
                                <span class="review-rating">${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5-review.rating)}</span>
                            </div>
                            <span class="review-date">${formatDate(review.createdDate)}</span>
                        </div>
                        <div class="review-content">${escapeHtml(review.content)}</div>
                    </div>
                `;
            });

            container.html(html);
        }

        function displayNoReviews() {
            $('#reviews-container').html(`
                <div class="no-reviews">
                    <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p>ì²« ë²ˆì§¸ ë¦¬ë·°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                </div>
            `);
        }

        function displayPagination(totalPages, currentPage) {
            if (totalPages <= 1) {
                $('#review-pagination').empty();
                return;
            }

            let html = '';

            if (currentPage > 1) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ì´ì „</a>
                </li>`;
            }

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            }

            if (currentPage < totalPages) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ë‹¤ìŒ</a>
                </li>`;
            }

            $('#review-pagination').html(html);
        }

        function changePage(page) {
            currentPage = page;
            loadReviews(page);
        }

        function updateReviewCount(count) {
            $('#review-total-count').text(`(${count})`);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function addToCart() {
            const paramData = {
                itemId: $("#itemId").val(),
                count: $("#count").val()
            };

            try {
                const res = await tokenManager.fetchWithToken("/cart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(paramData)
                });

                if (res.ok) {
                    if (confirm("ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ë‹´ê²¼ìŠµë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        location.href = "/cart";
                    }
                } else if (res.status === 401) {
                    alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”");
                    location.href = "/members/login";
                } else {
                    const text = await res.text();
                    alert(text);
                }
            } catch (err) {
                console.error("ì¥ë°”êµ¬ë‹ˆ ìš”ì²­ ì‹¤íŒ¨:", err);
                alert("ì¥ë°”êµ¬ë‹ˆ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
        async function order(){
            var paramData = {
                itemId : $("#itemId").val(),
                count : $("#count").val()
            };

            try {
                const res = await tokenManager.fetchWithToken("/cart", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(paramData)
                });

                if (res.ok) {
                    location.href = '/cart';
                } else if (res.status === 401) {
                    alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”');
                    location.href = '/members/login';
                } else {
                    const errorText = await res.text();
                    alert(errorText);
                }
            } catch (err) {
                console.error("ì£¼ë¬¸ ìš”ì²­ ì‹¤íŒ¨:", err);
                alert("ì£¼ë¬¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        function addLike(itemId) {
            const url = "/item/" + itemId + "/like";

            fetch(url, {
                method: 'POST',
                headers: {
                }
            }).then(response => {
                if (response.ok) {
                    const likeCountElement = document.getElementById('like-count');
                    let currentLikes = parseInt(likeCountElement.innerText);
                    likeCountElement.innerText = currentLikes + 1;
                    alert('ì´ ìƒí’ˆì„ ì¢‹ì•„í•©ë‹ˆë‹¤.');
                } else {
                    alert('ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
    </script>
</div>
</body>
</html>