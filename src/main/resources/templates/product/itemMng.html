<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<head>
  <meta charset="utf-8" />
  <!--<meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>-->
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div layout:fragment="content">
  <div class="admin-container">
    <h1>상품 목록</h1>

    <form th:action="@{'/admin/items/' + ${items.number}}" role="form" method="get" th:object="${items}">
      <div class="delete-controls">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <button type="button" id="deleteBtn" class="btn-submit-del" disabled>선택 항목 삭제</button><br>
            <span class="ml-2 text-muted">선택된 상품을 삭제할 수 있습니다.</span>
          </div>
          <div class="text-muted">
            총 <span th:text="${items.totalElements}">0</span>개의 상품
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table product-table">
          <thead>
          <tr>
            <th style="width:50px;"><input type="checkbox" id="selectAll" title="전체 선택"></th>
            <th>상품ID</th>
            <th>상품명</th>
            <th>상태</th>
            <th>등록자</th>
            <th>등록일</th>
            <th>관리</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="item, iterStat : ${items.content}">
            <td><input type="checkbox" class="item-checkbox" th:value="${item.id}" th:name="itemIds"></td>
            <td th:text="${item.id}"></td>
            <td><a th:href="'/admin/item/'+${item.id}" th:text="${item.itemNm}" style="text-decoration:none; color:inherit;"></a></td>
            <td>
                            <span th:if="${item.itemSellStatus != null}"
                                  th:classappend="${item.itemSellStatus.name() == 'SELL'} ? 'status-sell' : 'status-sold-out'"
                                  th:text="${item.itemSellStatus.name() == 'SELL'} ? '판매중' : '품절'"></span>
              <span th:unless="${item.itemSellStatus != null}">상태 없음</span>
            </td>
            <td th:text="${item.createdBy}"></td>
            <td th:text="${#temporals.format(item.regTime, 'yyyy-MM-dd HH:mm')}"></td>
            <td>
              <button type="button" class="btn-submit-add" th:data-item-id="${item.id}">수정</button>
              <button type="button" class="btn-submit-re" th:data-item-id="${item.id}" th:data-item-name="${item.itemNm}">삭제</button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <div th:with="start=${(items.number div maxPage)*maxPage + 1},
                           end=${(items.totalPages == 0) ? 1 : ((start + maxPage - 1) < items.totalPages ? start + maxPage - 1 : items.totalPages)}">
        <ul class="pagination justify-content-center">
          <li class="page-item" th:classappend="${items.first} ? 'disabled'">
            <a href="#" class="page-link" th:data-page="${items.number - 1}">&lt;</a>
          </li>
          <li class="page-item" th:each="page : ${#numbers.sequence(start, end)}"
              th:classappend="${items.number eq (page-1)} ? 'active'">
            <a href="#" th:text="${page}" class="page-link" th:data-page="${page-1}"></a>
          </li>
          <li class="page-item" th:classappend="${items.last} ? 'disabled'">
            <a href="#" class="page-link" th:data-page="${items.number + 1}">&gt;</a>
          </li>
        </ul>
      </div>

      <div class="form-inline justify-content-center mt-4" th:object="${itemSearchDto}">
        <select id="searchDateType" th:field="*{searchDateType}" class="form-control" style="width:auto;">
          <option value="all">전체 기간</option>
          <option value="1d">1일</option>
          <option value="1w">1주</option>
          <option value="1m">1개월</option>
          <option value="6m">6개월</option>
        </select>
        <select id="searchSellStatus" th:field="*{searchSellStatus}" class="form-control" style="width:auto;">
          <option value="">판매 상태 (전체)</option>
          <option value="SELL">판매</option>
          <option value="SOLD_OUT">품절</option>
        </select>
        <select id="searchBy" th:field="*{searchBy}" class="form-control" style="width:auto;">
          <option value="itemNm">상품명</option>
          <option value="createdBy">등록자</option>
        </select>
        <input id="searchQuery" th:field="*{searchQuery}" type="text" class="form-control" placeholder="검색어를 입력해주세요">
        <button id="searchBtn" type="button" class="btn-submit">검색</button>
      </div>
    </form>
  </div>
</div>
<th:block layout:fragment="script">
  <script th:inline="javascript">
    (function() {
      function initItemManagement() {
        // 삭제 버튼 활성/비활성 상태 업데이트
        function updateDeleteButtonState() {
          var checkedCount = $(".item-checkbox:checked").length;
          $("#deleteBtn").prop("disabled", checkedCount === 0);
          $("#deleteBtn").toggleClass("disabled", checkedCount === 0);
        }

        // 전체 선택 체크박스 상태 업데이트
        function updateSelectAllState() {
          var totalCheckboxes = $(".item-checkbox").length;
          var checkedCheckboxes = $(".item-checkbox:checked").length;

          if (checkedCheckboxes === 0) {
            $("#selectAll").prop("indeterminate", false).prop("checked", false);
          } else if (checkedCheckboxes === totalCheckboxes) {
            $("#selectAll").prop("indeterminate", false).prop("checked", true);
          } else {
            $("#selectAll").prop("indeterminate", true).prop("checked", false);
          }
        }

        // 체크박스 이벤트
        $(document).on("change", ".item-checkbox", function () {
          updateDeleteButtonState();
          updateSelectAllState();
        });

        $(document).on("change", "#selectAll", function() {
          var isChecked = $(this).prop("checked");
          $(".item-checkbox").prop("checked", isChecked);
          updateDeleteButtonState();
          updateSelectAllState();
        });

        // 선택 삭제 버튼
        $(document).off("click", "#deleteBtn").on("click", "#deleteBtn", function(e) {
          e.preventDefault();
          if ($(this).prop("disabled")) return;

          var selectedItems = $(".item-checkbox:checked").map(function(){ return $(this).val(); }).get();
          if (!confirm("선택된 " + selectedItems.length + "개의 상품을 삭제하시겠습니까?")) return;

          var token = $("meta[name='_csrf']").attr("content");
          var header = $("meta[name='_csrf_header']").attr("content");

          $.ajax({
            url: "/admin/items",
            type: "DELETE",
            data: $.param({ itemIds: selectedItems }, true),
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            beforeSend: function(xhr){
              if(header && token) xhr.setRequestHeader(header, token);
            },
            success: function(){ alert("선택된 상품 삭제 완료"); location.reload(); },
            error: function(xhr){ alert(xhr.responseText || "삭제 중 오류 발생"); }
          });
        });

        // 개별 삭제 버튼
        $(document).off("click", ".btn-submit-re").on("click", ".btn-submit-re", function(){
          var itemId = $(this).data("item-id");
          var itemName = $(this).data("item-name");
          if (!confirm("상품 '" + itemName + "'을(를) 삭제하시겠습니까?")) return;

          var token = $("meta[name='_csrf']").attr("content");
          var header = $("meta[name='_csrf_header']").attr("content");

          $.ajax({
            url: "/admin/items",
            type: "DELETE",
            data: "itemIds=" + encodeURIComponent(itemId),
            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
            beforeSend: function(xhr){ if(header && token) xhr.setRequestHeader(header, token); },
            success: function(){ alert("삭제 완료"); location.reload(); },
            error: function(xhr){ alert(xhr.responseText || "삭제 중 오류"); }
          });
        });

        // 수정 버튼
        $(document).off("click", ".btn-submit-add").on("click", ".btn-submit-add", function() {
          var itemId = $(this).data("item-id");
          location.href = "/admin/item/" + itemId;
        });

        // 검색 버튼
        $(document).off("click", "#searchBtn").on("click", "#searchBtn", function(e) {
          e.preventDefault();
          page(0);
        });

        // 페이지 링크 클릭 이벤트 (한 번만 등록)
        $(document).off("click", ".page-link").on("click", ".page-link", function(e){
          e.preventDefault(); // form submit 막기
          var page = $(this).data("page");
          if (page < 0) return;
          window.page(page); // 기존 page() 함수 호출
        });

        // 초기 상태 업데이트
        updateDeleteButtonState();
        updateSelectAllState();
      }

      // 페이지 이동 함수
      window.page = function(page) {
        var searchDateType = encodeURIComponent($("#searchDateType").val() || "");
        var searchSellStatus = encodeURIComponent($("#searchSellStatus").val() || "");
        var searchBy = encodeURIComponent($("#searchBy").val() || "");
        var searchQuery = encodeURIComponent($("#searchQuery").val() || "");

        location.href = "/admin/items/" + page
                + "?searchDateType=" + searchDateType
                + "&searchSellStatus=" + searchSellStatus
                + "&searchBy=" + searchBy
                + "&searchQuery=" + searchQuery;
      };

      // jQuery 로드 체크
      if(typeof jQuery === 'undefined'){
        var script = document.createElement('script');
        script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
        script.onload = initItemManagement;
        document.head.appendChild(script);
      } else {
        $(document).ready(initItemManagement);
      }
    })();
  </script>
</th:block>

</body>
</html>