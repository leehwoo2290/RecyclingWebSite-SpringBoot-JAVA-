<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div layout:fragment="content">

    <h2>ì¥ë°”êµ¬ë‹ˆ</h2>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <div class="board-container">
        <table class="table cart-table">
            <thead>
            <tr>
                <!-- ìƒí’ˆì´ë¯¸ì§€ ì»¬ëŸ¼ ì‚­ì œ -->
                <th>ìƒí’ˆëª…</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê°€ê²©</th>
                <th>í•©ê³„</th>
                <th>ì‘ì—…</th>
            </tr>
            </thead>
            <tbody id="cart-body">
            <!-- JSì—ì„œ ë Œë”ë§ -->
            </tbody>
        </table>
        <br><br>

        <!-- ìš”ì•½ ì •ë³´ ë°•ìŠ¤ -->
        <div class="summary-box mt-4">
            <div class="row">
                <div class="col-md-6">
                    <h2 class="text">ğŸ“¦ ì´ ìƒí’ˆ ìˆ˜ëŸ‰: <span id="total-quantity" class="text">0</span> ê°œ</h2>
                </div>
                <div class="col-md-6 text-end">
                    <h3 class="text">ğŸ’° ì´ ê²°ì œ ê¸ˆì•¡: <span id="cart-total" class="text">0</span> ì›</h3>
                </div>
            </div>
        </div>

        <div class="cartList-form justify-content-end gap-2">
            <button id="btn-clear" class="btn btn-cart">ì „ì²´ ë¹„ìš°ê¸°</button>
            <button id="btn-order" class="btn btn-cart">ì£¼ë¬¸í•˜ê¸°</button>
        </div>
        <br><br><br>

        <th:block layout:fragment="script">
            <script>
                async function loadCart() {
                    const res = await tokenManager.fetchWithToken("/cart/api/cart");
                    if (!res.ok) {
                        if (res.status === 401) window.location.href = "/members/login";
                        return;
                    }
                    const data = await res.json();
                    renderCart(data);
                }

                function renderCart(data) {
                    const tbody = $("#cart-body");
                    tbody.empty();

                    if (!data.cartItems || data.cartItems.length === 0) {
                        tbody.append(`<tr id="empty-cart-row">
            <td colspan="5" class="text-muted py-4">
                <div class="text-center">
                    <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                    <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </td>
        </tr>`);
                        calculateCartSummary();
                        return;
                    }

                    data.cartItems.forEach(item => {
                        tbody.append(`
            <tr data-id="${item.cartItemId}" data-price="${item.price}">
                <td>${item.itemNm}</td>
                <td><input type="number" min="1" class="form-control form-control-sm qty-input" value="${item.count}"/></td>
                <td>${item.price.toLocaleString()}</td>
                <td class="item-total">${(item.price*item.count).toLocaleString()}</td>
                <td><button class="btn btn-danger btn-del btn-delete">ì‚­ì œ</button></td>
            </tr>
        `);
                    });

                    calculateCartSummary();
                }

                // ì´í•˜ JSëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
                function calculateCartSummary() {
                    let totalAmount = 0;
                    let totalQuantity = 0;

                    $("#cart-body tr:not(#empty-cart-row)").each(function(){
                        let price = parseInt($(this).data("price")) || 0;
                        let qty = parseInt($(this).find(".qty-input").val()) || 0;
                        totalAmount += price * qty;
                        totalQuantity += qty;
                    });

                    $("#cart-total").text(totalAmount.toLocaleString());
                    $("#total-quantity").text(totalQuantity);

                    if ($("#cart-body tr:not(#empty-cart-row)").length === 0) {
                        $("#cart-total").text("0");
                        $("#total-quantity").text("0");
                        showEmptyCartMessage();
                    }
                }

                function showEmptyCartMessage() {
                    if ($("#empty-cart-row").length === 0) {
                        $("#cart-body").append(`
                <tr id="empty-cart-row">
                    <td colspan="5" class="text-muted py-4">
                        <div class="text-center">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </td>
                </tr>
            `);
                    }
                }

                function hideEmptyCartMessage() {
                    $("#empty-cart-row").remove();
                }

                function updateItemTotal(row) {
                    let price = parseInt(row.data("price")) || 0;
                    let qty = parseInt(row.find(".qty-input").val()) || 1;
                    row.find(".item-total").text((price*qty).toLocaleString());
                }

                $(document).on("change input keyup", ".qty-input", function() {
                    let row = $(this).closest("tr");
                    let cartItemId = row.data("id");
                    let newQty = parseInt($(this).val()) || 1;
                    if (newQty < 1) { newQty = 1; $(this).val(newQty); }
                    updateItemTotal(row);
                    calculateCartSummary();

                    clearTimeout($(this).data('timeout'));
                    $(this).data('timeout', setTimeout(async function() {
                        try {
                            const res = await tokenManager.fetchWithToken("/cart/" + cartItemId, {
                                method: "PATCH",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ count: newQty })
                            });
                            if (!res.ok) console.error('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', await res.text());
                        } catch (err) { console.error('ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', err); }
                    }, 500));
                });

                $(document).on("click", ".btn-delete", function(){
                    let row = $(this).closest("tr");
                    let cartItemId = row.data("id");
                    if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        (async () => {
                            try {
                                const res = await tokenManager.fetchWithToken("/cart/" + cartItemId + "/delete", { method: "DELETE" });
                                if (res.ok) {
                                    row.fadeOut(300, function() {
                                        $(this).remove();
                                        calculateCartSummary();
                                        if ($("#cart-body tr:not(#empty-cart-row)").length === 0) showEmptyCartMessage();
                                    });
                                } else alert(await res.text());
                            } catch (err) { alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
                        })();
                    }
                });

                $("#btn-clear").click(function(){
                    if (confirm("ì¥ë°”êµ¬ë‹ˆë¥¼ ëª¨ë‘ ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        (async () => {
                            try {
                                const res = await tokenManager.fetchWithToken("/cart/clear", { method: "POST" });
                                if (res.ok) {
                                    $("#cart-body tr:not(#empty-cart-row)").fadeOut(300, function() {
                                        $(this).remove();
                                        calculateCartSummary();
                                        showEmptyCartMessage();
                                    });
                                } else alert(await res.text());
                            } catch (err) { alert('ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
                        })();
                    }
                });

                $("#btn-order").click(function(){
                    let totalQuantity = parseInt($("#total-quantity").text()) || 0;
                    if (totalQuantity === 0) { alert("ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                    if (confirm(`ì´ ${totalQuantity}ê°œ ìƒí’ˆì„ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        window.location.href = "cart/order";
                    }
                });

                $(document).ready(async function(){
                    await loadCart();
                    if ($("#cart-body tr:not(#empty-cart-row)").length > 0) hideEmptyCartMessage();
                    calculateCartSummary();
                    $("#cart-body tr:not(#empty-cart-row)").each(function(){ updateItemTotal($(this)); });
                });
            </script>
        </th:block>

</body>
</html>
