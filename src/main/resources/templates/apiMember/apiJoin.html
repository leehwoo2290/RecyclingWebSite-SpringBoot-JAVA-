<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css">
    <title>회원가입</title>
</head>
<body>
<div layout:fragment="content">
    <h2>회원가입</h2>

    <!-- 이메일 인증 -->
    <div>
        <label for="memail">이메일</label>
        <input type="email" class="form-control" id="memail" required>
        <button type="button" id="sendEmailBtn" class="btn-submit" >인증번호 발송</button>
        <span id="emailMessage"></span>
    </div>

    <!-- 인증번호 입력 -->
    <div id="verifySection" style="display:none;">
        <input type="text" id="emailCode" class="form-control" placeholder="인증번호 입력">
        <button type="button" id="verifyBtn" class="btn-submit" >인증 확인</button>
    </div>

    <!-- 회원가입 폼 -->
    <form id="registerForm" style="display:none;" method="post">
        <input type="hidden" id="hiddenMemail" name="memail">

        <div>
            <label for="mid">아이디</label>
            <input type="text" id="mid" name="mid" class="form-control"  required>
        </div><br>

        <div>
            <label for="mname">이름</label>
            <input type="text" id="mname" name="mname" class="form-control"  required>
        </div><br>

        <div>
            <label for="mphoneNumber">전화번호</label>
            <input type="text" id="mphoneNumber" name="mphoneNumber" class="form-control"  required>
        </div><br>

        <!-- 비밀번호 입력 -->
        <div>
            <label for="mpassword">비밀번호</label>
            <input type="password" id="mpassword" name="mpassword" class="form-control" required>
        </div><br>

        <div>
            <label for="mpasswordcheck">비밀번호 확인</label>
            <input type="password" id="mpasswordcheck" name="mpasswordcheck" class="form-control"  required>
        </div><br>

        <div>
            <input type="text" id="mpostcode" name="mpostcode" placeholder="우편번호" class="form-control"  readonly>
            <input type="text" id="maddress" name="maddress" placeholder="주소" class="form-control"  readonly>
            <input type="text" id="mdetailAddress" name="mdetailAddress" class="form-control"  placeholder="상세주소">
            <button type="button" id="addrBtn" class="btn-submit">주소 검색</button>
        </div><br>

        <button type="button" id="checkBtn" class="btn-submit">비밀번호 체크</button>
        <button type="submit" id="submitBtn" class="btn-submit" disabled>회원가입</button>
        <span id="pwMessage" style="color:red;"></span>

    </form>
</div>

<th:block layout:fragment="script">
    <!-- 외부 스크립트 -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/js/addAddressDetails.js"></script>
    <script src="/js/passwordCheck.js"></script>
    <script src="/js/mailCheck.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // 폼 제출 시 API 호출
        document.getElementById("registerForm").addEventListener("submit", async function(event) {
            event.preventDefault();

            const payload = {
                mid: document.getElementById("mid").value,
                mname: document.getElementById("mname").value,
                mphoneNumber: document.getElementById("mphoneNumber").value,
                memail: document.getElementById("hiddenMemail").value,
                mpassword: document.getElementById("mpassword").value,
                mpostcode: document.getElementById("mpostcode").value,
                maddress: document.getElementById("maddress").value,
                mdetailAddress: document.getElementById("mdetailAddress").value,
                mSocialActivate: false
            };

            try {
                const res = await axios.post("/api/members/", payload, {
                    headers: { "Content-Type": "application/json" }
                });

                if (res.data.code === 201) {
                    alert("회원가입 성공!");
                    window.location.href = "/";
                } else {
                    alert("회원가입 실패: " + res.data.message);
                }
            } catch (err) {
                console.error(err);
                alert("회원가입 중 오류 발생");
            }
        });
    </script>
</th:block>
</body>
</html>
