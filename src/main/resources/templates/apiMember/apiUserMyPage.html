<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* ===== 프로필 영역 ===== */
        #profile-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-img {
            border-radius: 50%;
            width: 120px;
            height: 120px;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .profile-actions .btn {
            text-decoration: none;
            padding: 6px 15px;
            font-size: 14px;
            border-radius: 5px;
            color: #fff;
        }

        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }

        /* ===== 주문 내역 카드 ===== */
        .board-container {
            max-width: 900px;
            margin: 0 auto 50px;
        }

        .order-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .order-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .order-header strong { margin-right: 5px; }

        .order-items li {
            font-size: 13px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-items li:last-child { border-bottom: none; }

        .cancel-btn {
            background-color: #dc3545;
            color: #fff;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .cancel-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .review-btn {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        /* ===== 페이징 ===== */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .pagination li {
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .pagination li.active {
            background-color: #007bff;
            color: #fff;
            pointer-events: none;
        }

        .pagination li a {
            display: block;
            padding: 6px 12px;
            text-decoration: none;
            color: inherit;
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="mypage-container">

        <!-- ===== 회원 정보 영역 ===== -->
        <div class="card-body" id="profile-container">
            <h2>내 정보</h2>
            <img id="profile-img" src="/images/default_profile.png" alt="프로필 이미지" class="profile-img">
            <p id="member-name"></p>
            <p id="member-email"></p>
            <input type="hidden" id="profileImagePath">

            <div class="profile-actions">
                <a href="/members/modify" class="btn btn-success">회원정보 수정</a>
                <a href="#" id="deleteMemberBtn" class="btn btn-danger">회원 탈퇴</a>
                <!-- <a href="/members/delete" class="btn btn-danger">회원 탈퇴</a>-->
            </div>
        </div>

        <hr>

        <!-- ===== 주문 내역 영역 ===== -->
        <div class="board-container">
            <h2>주문 내역</h2>
            <div id="order-container"><p>불러오는 중...</p></div>
            <nav id="pagination-container"></nav>
        </div>

    </div>

    <!-- ===== JS 스크립트 ===== -->
    <th:block layout:fragment="script">
        <script src="/js/tokenManager.js"></script>
        <script type="module">
            import { initMemberPage } from '/js/memberInfoUtils.js';

            window.addEventListener("DOMContentLoaded", async () => {
                await initMemberPage();

                // 프로필 이미지 교체
                const profileImg = document.getElementById("profile-img");
                const profilePathInput = document.getElementById("profileImagePath");
                if (profileImg && profilePathInput && profilePathInput.value) {
                    profileImg.src = profilePathInput.value;
                }

                // 주문 내역 로드
                await loadOrders(1);
            });

            document.getElementById('deleteMemberBtn').addEventListener('click', async (e) => {
                e.preventDefault();

                if (!confirm('정말로 회원을 탈퇴하시겠습니까?')) return;

                try {
                    const response = await tokenManager.fetchWithToken('/api/members/', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                        // 백엔드에서 Authentication으로 식별하므로 body 불필요
                    });

                    if (response.ok) {
                        alert('회원 탈퇴가 완료되었습니다.');
                        // AccessToken/RefreshToken 정리
                        tokenManager.clearAccessToken();
                        // 쿠키에 RefreshToken이 있다면 로그아웃 API도 호출 가능
                        window.location.href = '/'; // 탈퇴 후 메인페이지 이동
                    } else {
                        const result = await response.json();
                        alert('탈퇴 실패: ' + (result.message || '알 수 없는 오류'));
                    }
                } catch (err) {
                    console.error('회원 탈퇴 요청 중 오류:', err);
                    alert('탈퇴 처리 중 오류가 발생했습니다.');
                }
            });
            // 주문 내역 불러오기
            async function loadOrders(page = 1) {
                try {
                    await window.tokenManager.initOnPageLoad();
                    const res = await window.tokenManager.fetchWithToken(`/cart/order/api/history?page=${page}&pageSize=5`);
                    if (!res.ok) throw new Error("주문 내역 불러오기 실패");
                    const data = await res.json();
                    renderOrders(data);
                    renderPagination(data.page, data.totalPages);
                } catch (err) {
                    console.error(err);
                    document.getElementById('order-container').innerHTML = '<p>주문 내역 불러오기 실패</p>';
                }
            }

            function renderOrders(data) {
                const container = document.getElementById('order-container');
                container.innerHTML = '';

                if (!data.orders || data.orders.length === 0) {
                    container.innerHTML = `<p>주문 내역이 없습니다.</p>`;
                    return;
                }

                data.orders.forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    card.dataset.orderId = order.orderId;

                    card.innerHTML = `
                        <div class="order-header">
                          <div>
                            <strong>주문 ID:</strong> ${order.orderId}
                            <strong>상태:</strong> <span class="order-status">${order.status}</span>
                            <strong>총 금액:</strong> ${data.orderTotalMap[order.orderId]}원
                          </div>
                          ${order.status !== 'CANCEL' ? '<button class="cancel-btn">주문 취소</button>' : ''}
                        </div>
                        <ul class="order-items">
                          ${order.orderItems.map(item => `
                            <li>
                              <span><strong>${item.itemNm}</strong> | 수량: ${item.count} | 가격: ${item.orderPrice}원</span>
                              ${order.status !== 'CANCEL' ? `<button class="review-btn" data-item-id="${item.itemId || ''}">리뷰 작성</button>` : ''}
                            </li>
                          `).join('')}
                        </ul>
                    `;

                    container.appendChild(card);
                });

                // 리뷰 작성 버튼 이벤트
                container.querySelectorAll('.review-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = btn.dataset.itemId;
                        if (!itemId) {
                            alert("⚠ itemId가 내려오지 않았습니다. DTO를 확인하세요.");
                            return;
                        }
                        window.location.href = `/reviews/view/open?itemId=${itemId}`;
                    });
                });

                // 주문 취소 버튼 이벤트
                container.querySelectorAll('.cancel-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const card = btn.closest('.order-card');
                        const orderId = card.dataset.orderId;
                        if (!confirm('정말 주문을 취소하시겠습니까?')) return;

                        try {
                            btn.disabled = true;
                            btn.textContent = '취소 중...';

                            await window.tokenManager.initOnPageLoad();
                            const res = await window.tokenManager.fetchWithToken('/cart/order/cancel', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: new URLSearchParams({ orderId })
                            });

                            if (!res.ok) throw new Error(`HTTP ${res.status}`);
                            const result = await res.text();

                            if (result === 'success') {
                                card.querySelector('.order-status').textContent = 'CANCEL';
                                btn.remove();
                                alert('주문이 성공적으로 취소되었습니다.');
                                setTimeout(() => loadOrders(1), 500);
                            } else {
                                throw new Error(result || '알 수 없는 오류');
                            }

                        } catch (error) {
                            alert('주문 취소 실패: ' + error.message);
                            btn.disabled = false;
                            btn.textContent = '주문 취소';
                        }
                    });
                });
            }

            function renderPagination(page, totalPages) {
                if (totalPages <= 1) {
                    document.getElementById('pagination-container').innerHTML = '';
                    return;
                }

                const container = document.getElementById('pagination-container');
                let html = '<ul class="pagination">';

                if (page > 1) html += `<li><a href="#" data-page="${page-1}">이전</a></li>`;
                for (let i = 1; i <= totalPages; i++) {
                    html += `<li class="${i===page?'active':''}"><a href="#" data-page="${i}">${i}</a></li>`;
                }
                if (page < totalPages) html += `<li><a href="#" data-page="${page+1}">다음</a></li>`;
                html += '</ul>';

                container.innerHTML = html;

                container.querySelectorAll('.pagination a').forEach(link => {
                    link.addEventListener('click', e => {
                        e.preventDefault();
                        const selectedPage = parseInt(e.target.dataset.page);
                        if (!isNaN(selectedPage)) loadOrders(selectedPage);
                    });
                });
            }
        </script>
    </th:block>
</div>
</body>
</html>
