<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div layout:fragment="content">
  <div class="card-body">
    <div>

      <form id="modifyForm" style="justify-items: anchor-center;">
        <div class="input-group mb-3">
          <span class="input-group-text">ID</span>
          <input type="text" id="mid" name="mid" class="form-control" readonly>
        </div><br>

        <div class="input-group mb-3">
          <span class="input-group-text">PW</span>
          <input type="password" class="form-control" id="mpassword" name="mpassword" placeholder="비밀번호">
        </div><br>

        <div class="input-group mb-3">
          <span class="input-group-text">PWCHECK</span>
          <input type="password" class="form-control" id="mpasswordcheck" name="mpasswordcheck" placeholder="비밀번호 확인">
        </div><br>

        <div id="pwMessage" style="color:red; font-size:0.9em; margin-bottom:10px;"></div>

        <div class="input-group mb-3">
          <span class="input-group-text">NAME</span>
          <input type="text" id="mname" name="mname" class="form-control">
        </div><br>

        <div class="input-group mb-3">
          <span class="input-group-text">PHONENUMBER</span>
          <input type="text" id="mphoneNumber" name="mphoneNumber" class="form-control">
        </div><br>

        <div class="input-group mb-3">
          <span class="input-group-text">EMAIL</span>
          <input type="email" id="memail" name="memail" class="form-control" readonly>
        </div><br>

        <div>
          <input type="text" id="mpostcode" name="mpostcode" class="form-control" placeholder="우편번호">
          <input type="text" id="maddress" name="maddress" class="form-control" placeholder="주소">
          <input type="text" id="mdetailAddress" name="mdetailAddress" class="form-control" placeholder="상세 주소">
          <button type="button" id="addrBtn" class="btn-submit">주소 검색</button>
        </div><br>

        <div>
          <input type="file" id="profileInput" data-type="profile">
          <button type="button" class="uploadBtn" data-type="profile">업로드</button>


        </div><br>

        <div class="my-4">
          <div class="float-end">
            <button type="button" id="checkBtn" class="btn-submit">비밀번호 체크</button>
            <button type="submit" id="submitBtn" class="btn-submit" disabled>Submit</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<th:block layout:fragment="script">
  <!-- 외부 스크립트 -->
  <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <script src="/js/addAddressDetails.js"></script>
  <script type="module" src="/js/uploadImages.js"></script>
  <script src="/js/passwordCheck.js"></script>
  <!--<script src="/js/tokenManager.js"></script>-->


  <script type="module">
    import { initMemberPage } from '/js/memberInfoUtils.js';

    window.addEventListener("DOMContentLoaded", async () => {
      await initMemberPage();
    });

  </script>

  <script>
    // 폼 제출 시 API 호출
    document.getElementById("modifyForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const formData = {
        mid: document.getElementById("mid").value,
        mnewPassword: document.getElementById("mpassword").value,
        mname: document.getElementById("mname").value,
        mphoneNumber: document.getElementById("mphoneNumber").value,
        memail: document.getElementById("memail").value,
        mpostcode: document.getElementById("mpostcode").value,
        maddress: document.getElementById("maddress").value,
        mdetailAddress: document.getElementById("mdetailAddress").value
      };

      try {
        const res = await window.tokenManager.fetchWithToken('/api/members/', {
          method: "put",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData)
        });

        const result = await res.json();
        if (res.ok) {
          alert("회원정보 수정 성공!");
          // 성공 후 main.html로 이동
          window.location.href = '/';
        } else {
          alert("회원정보 수정 실패: " + (result.message || "알 수 없는 오류"));
        }
      } catch (err) {
        console.error("수정 요청 중 오류:", err);
        alert("수정 요청 중 오류 발생!");
      }
    });
  </script>
</th:block>
</body>
</html>
