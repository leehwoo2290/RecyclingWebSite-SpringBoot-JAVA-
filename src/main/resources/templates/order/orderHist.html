<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div layout:fragment="content">
  <div class="board-container">
    <h2>ì£¼ë¬¸ ë‚´ì—­</h2>

    <div class="card-hi-row" id="order-container">
      <p>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <nav aria-label="Page navigation example" id="pagination-container"></nav>

    <div class="card-com-row">
      <div class="card com">
        <a th:href="@{/}" class="order-main"
           style="text-decoration: none; color: inherit; font-size: 25px">í™ˆìœ¼ë¡œ</a>
      </div>
    </div>
  </div>

  <th:block layout:fragment="script">
    <script type="module">

      // ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
      async function loadOrders(page = 1) {
        try {
          await window.tokenManager.initOnPageLoad();
          const res = await window.tokenManager.fetchWithToken(`/cart/order/api/history?page=${page}&pageSize=5`);
          if (!res.ok) throw new Error("ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

          const data = await res.json();
          renderOrders(data);
          renderPagination(data.page, data.totalPages);
        } catch (err) {
          console.error(err);
          document.getElementById('order-container').innerHTML = '<p>ì£¼ë¬¸ ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
        }
      }

      // ğŸŒŸ ë¦¬ë·° ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜ (ì‚­ì œë¨. renderOrders ë‚´ë¶€ì—ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ë„ë¡ ë³µêµ¬)
      // function openReviewPage(orderId, itemNm, itemId) { ... }

      // ì£¼ë¬¸ ë‚´ì—­ ë Œë”ë§
      function renderOrders(data) {
        const container = document.getElementById('order-container');
        container.innerHTML = '';

        if (!data.orders || data.orders.length === 0) {
          container.innerHTML = `<p>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
          return;
        }

        data.orders.forEach(order => {
          const card = document.createElement('div');
          card.className = 'card mb-3';
          card.dataset.orderId = order.orderId;

          // ì£¼ë¬¸ ìƒíƒœì— ë”°ë¥¸ ë²„íŠ¼ í‘œì‹œ ë¡œì§ ê°œì„ 
          const isCancelled = order.status === 'CANCEL' || order.status === 'CANCELLED';

          card.innerHTML = `
            <div class="card-header">
              <strong>ì£¼ë¬¸ ID:</strong> ${order.orderId} |
              <strong>íšŒì› ID:</strong> ${order.memberId} |
              <strong>ì£¼ë¬¸ ìƒíƒœ:</strong> <span class="order-status">${order.status}</span> |
              <strong>ì´ ê²°ì œ ê¸ˆì•¡:</strong> ${data.orderTotalMap[order.orderId]} ì› |
              <strong>ì£¼ë¬¸ì¼:</strong> ${new Date(order.orderDate).toLocaleString()}
              ${!isCancelled ? '<button class="btn btn-submit cancel-btn">ì£¼ë¬¸ ì·¨ì†Œ</button>' : ''}
            </div>
            <ul class="list-group list-group-flush">
              ${order.orderItems.map(item => {
            // ğŸŒŸğŸŒŸğŸŒŸ itemIdë¥¼ item.itemIdì—ì„œ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬ (ë²„íŠ¼ ìƒì„± ì¡°ê±´ í™•ë³´)
            const itemId = item.itemId || 0;
            const itemNm = item.itemNm || '';

            // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ìƒì„± (Controller ìš”êµ¬ì‚¬í•­: orderId, itemId)
            const reviewUrl = `/reviews/view/open?orderId=${order.orderId}&itemNm=${encodeURIComponent(itemNm)}&itemId=${itemId}`;

            return `
                  <li class="list-group-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <strong>ìƒí’ˆëª…:</strong> ${item.itemNm} |
                        <strong>ìˆ˜ëŸ‰:</strong> ${item.count} |
                        <strong>ê°€ê²©:</strong> ${item.orderPrice} ì›
                      </div>
                      ${!isCancelled && itemId > 0
                    // ğŸŒŸğŸŒŸğŸŒŸ ë²„íŠ¼ì„ ë‹¤ì‹œ ë³´ì´ë„ë¡ ìˆ˜ì • (onclick ì§ì ‘ ì‚¬ìš©) ğŸŒŸğŸŒŸğŸŒŸ
                    ? `<button class="btn btn-sm btn-outline-primary"
                                     onclick="window.location.href='${reviewUrl}'"
                                     style="margin-left: 10px;">
                                 ë¦¬ë·° ì‘ì„±
                             </button>`
                    : ''}
                    </div>
                  </li>
                `;
          }).join('')}
            </ul>
          `;
          container.appendChild(card);
        });

        // ğŸŒŸ ë¦¬ë·° ì‘ì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (onclickìœ¼ë¡œ ëŒ€ì²´í–ˆìœ¼ë¯€ë¡œ)
        // container.querySelectorAll('.review-btn').forEach(btn => { ... });

        // ì£¼ë¬¸ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
        container.querySelectorAll('.cancel-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault();

            const card = btn.closest('.card');
            const orderId = card.dataset.orderId;

            if (!confirm('ì •ë§ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
              btn.disabled = true;
              btn.textContent = 'ì·¨ì†Œ ì¤‘...';

              await window.tokenManager.initOnPageLoad();

              const res = await window.tokenManager.fetchWithToken('/cart/order/cancel', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({ orderId })
              });

              if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`HTTP ${res.status}: ${errorText}`);
              }

              const result = await res.text();

              if (result === 'success') {
                card.querySelector('.order-status').textContent = 'CANCEL';

                // ì£¼ë¬¸ ì·¨ì†Œ ë²„íŠ¼ ì œê±°
                btn.remove();

                // ë¦¬ë·° ì‘ì„± ë²„íŠ¼ ì œê±° (onclick ë°©ì‹ì— ë§ê²Œ ì„ íƒì ë³€ê²½)
                card.querySelectorAll('button[onclick*="/reviews/view/open"]').forEach(rBtn => rBtn.remove());

                alert('ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                setTimeout(() => window.location.reload(), 1000);
              } else if (result === 'unauthorized') {
                alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/members/login';
              } else {
                throw new Error(result || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }

            } catch (error) {
              console.error('ì£¼ë¬¸ ì·¨ì†Œ ì˜¤ë¥˜:', error);

              if (error.message.includes('unauthorized') || error.message.includes('401')) {
                alert('ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/members/login';
                return;
              }

              alert('ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨: ' + error.message);
              btn.disabled = false;
              btn.textContent = 'ì£¼ë¬¸ ì·¨ì†Œ';
            }
          });
        });
      }

      // í˜ì´ì§• ë²„íŠ¼ ë Œë”ë§
      function renderPagination(page, totalPages) {
        if (totalPages <= 1) {
          document.getElementById('pagination-container').innerHTML = '';
          return;
        }

        const container = document.getElementById('pagination-container');
        let html = '<ul class="pagination justify-content-center">';

        if (page > 1) {
          html += ` <li class="page-item"><a class="page-link" href="#" data-page="${page - 1}">ì´ì „</a> </li>`;
        }

        for (let i = 1; i <= totalPages; i++) {
          html += ` <li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li> `;
        }

        if (page < totalPages) {
          html += ` <li class="page-item"><a class="page-link" href="#" data-page="${page + 1}">ë‹¤ìŒ</a></li> `;
        }

        html += '</ul>';
        container.innerHTML = html;

        container.querySelectorAll('.page-link').forEach(link => {
          link.addEventListener('click', e => {
            e.preventDefault();
            const selectedPage = parseInt(e.target.dataset.page);
            if (!isNaN(selectedPage)) loadOrders(selectedPage);
          });
        });
      }

      window.addEventListener('DOMContentLoaded', async () => {
        loadOrders(1);
      });

    </script>
  </th:block>
</div>
</body>
</html>