<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<head>
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<div layout:fragment="content">
    <div class="board-container">
        <div class="row mt-3">
            <div class="col">

                <h1>Í≥µÏßÄÏÇ¨Ìï≠</h1>
                <div class="card">

                    <table class="table board-table">
                        <thead>
                        <tr>
                            <th scope="col">Î≤àÌò∏</th>
                            <th scope="col">Ï†úÎ™©</th>
                            <th scope="col">ÏûëÏÑ±Ïûê</th>
                            <th scope="col">ÏûëÏÑ±Ïùº</th>
                            <th scope="col">Ï°∞Ìöå Ïàò</th>
                        </tr>
                        </thead>

                        <tbody th:with="link = ${pageAdminRequestDTO.getLink()}"
                               th:each="dto : ${responseDTO.dtoList}">
                        <tr class="table-body">
                            <td th:text="${dto.bno}"></td>
                            <td>
                                <a th:href="@{/board/read(bno=${dto.bno})}" style="text-decoration: none; color: inherit;">
                                    <span th:if="${dto.notice}" style="color:#009879; font-weight:bold">[Í≥µÏßÄ]</span>
                                    <span th:text="${dto.title}"></span>
                                </a>
                            </td>
                            <td th:text="${dto.writer}"></td>
                            <td>[[${#temporals.format(dto.regDate, 'yyyy-MM-dd')}]]</td>
                            <td th:text="${dto.viewCount}"></td>
                        </tr>
                        </tbody>
                    </table>

                    <div class="float-end">
                        <ul class="pagination flex-wrap">
                            <li class="page-item" th:classappend="${!responseDTO.prev} ? 'disabled' : ''">
                                <a href="javascript:void(0)" class="page-link"
                                   th:onclick="'movePage(' + (${responseDTO.page > 1 ? responseDTO.page - 1 : 1}) + ')'">Ïù¥Ï†Ñ</a>
                            </li>

                            <th:block th:each="i : ${#numbers.sequence(responseDTO.start, responseDTO.end)}">
                                <li th:class="${responseDTO.page == i} ? 'page-item active' : 'page-item'">
                                    <a href="javascript:void(0)" class="page-link" th:onclick="'movePage(' + ${i} + ')'" th:text="${i}"></a>
                                </li>
                            </th:block>

                            <li class="page-item" th:classappend="${!responseDTO.next} ? 'disabled': ''">
                                <a href="javascript:void(0)" class="page-link"
                                   th:onclick="'movePage(' + (${responseDTO.page < responseDTO.end ? responseDTO.page + 1 : responseDTO.end}) + ')'">Îã§Ïùå</a>
                            </li>
                        </ul>
                    </div>

                    <!-- üí° ÏàòÏ†ï: href Ï†úÍ±∞, id Ï∂îÍ∞Ä -->
                  <!--  <button type="button" class="btn-write" id="btnWrite">Í∏ÄÏì∞Í∏∞</button>-->
                    <!-- ÏàòÏ†ï: style="display:none;" Ï∂îÍ∞Ä - Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Î≤ÑÌäº Ïà®ÍπÄ -->
                    <button type="button" class="btn-write" id="btnWrite" style="display:none;">Í∏ÄÏì∞Í∏∞</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üí° Ï∂îÍ∞Ä: tokenManager.js Î°úÎìú -->
<th:block layout:fragment="script">
    <script th:src="@{/js/tokenManager.js}"></script>
    <script th:inline="javascript">
        console.log("Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎî©...");

        function movePage(pageNum) {
            console.log("ÌéòÏù¥ÏßÄ Ïù¥Îèô:", pageNum);
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('page', pageNum);
            window.location.href = window.location.pathname + '?' + urlParams.toString();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const pageLinks = document.querySelectorAll('.page-link[data-num]');
            pageLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageNum = this.getAttribute('data-num');
                    if (pageNum) {
                        movePage(pageNum);
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            console.log("ÌòÑÏû¨ ÌéòÏù¥ÏßÄ:", /*[[${responseDTO.page}]]*/);
            console.log("Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ:", /*[[${responseDTO.end}]]*/);
        });

        // üí° Ï∂îÍ∞Ä: Í∏ÄÏì∞Í∏∞ Î≤ÑÌäº Í∂åÌïú Ï≤¥ÌÅ¨ Î∞è ÌëúÏãú Î°úÏßÅ Î≥ÄÍ≤Ω
        /*document.addEventListener('DOMContentLoaded', function() {
            const btnWrite = document.getElementById("btnWrite");

            if (btnWrite) {
                btnWrite.addEventListener("click", async () => {
                    const res = await tokenManager.fetchWithToken("/board/register/check");

                    if (!res.ok) {
                        if (res.status === 401) {
                            alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                            window.location.href = "/members/login";
                        } else if (res.status === 403) {
                            alert("Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.");
                        }
                        return;
                    }

                    // üí° Í∂åÌïúÏù¥ ÏûàÏúºÎ©¥ Í∏ÄÏì∞Í∏∞ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                    window.location.href = "/board/register";
                });
            }
        });*/

        document.addEventListener('DOMContentLoaded', async function() {
            const btnWrite = document.getElementById("btnWrite");

            if (!btnWrite) return;

            try {
                // Í∂åÌïú Ï≤¥ÌÅ¨ API Ìò∏Ï∂ú
                const res = await tokenManager.fetchWithToken("/board/register/check");

                if (res.ok) {
                    // Ï∂îÍ∞Ä: Í∂åÌïúÏù¥ ÏûàÏúºÎ©¥ Î≤ÑÌäº ÌëúÏãú
                    btnWrite.style.display = 'inline-block';

                    // Ï∂îÍ∞Ä: ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Îì±Î°ù
                    btnWrite.addEventListener("click", function() {
                        window.location.href = "/board/register";
                    });
                } else if (res.status === 401) {
                    // ÏàòÏ†ï: Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Î≤ÑÌäº Ïà®ÍπÄ (ÏïåÎ¶º Ï†úÍ±∞)
                    console.log("Î°úÍ∑∏Ïù∏ ÌïÑÏöî - Í∏ÄÏì∞Í∏∞ Î≤ÑÌäº Ïà®ÍπÄ");
                } else if (res.status === 403) {
                    // ÏàòÏ†ï: Í∂åÌïú ÏóÜÎäî Í≤ΩÏö∞ Î≤ÑÌäº Ïà®ÍπÄ (ÏïåÎ¶º Ï†úÍ±∞)
                    console.log("Í∂åÌïú ÏóÜÏùå - Í∏ÄÏì∞Í∏∞ Î≤ÑÌäº Ïà®ÍπÄ");
                }
            } catch (err) {
                // Ï∂îÍ∞Ä: ÏóêÎü¨ Î∞úÏÉù ÏãúÏóêÎèÑ Î≤ÑÌäº Ïà®ÍπÄ
                console.log("Í∂åÌïú Ï≤¥ÌÅ¨ Ïã§Ìå® - Í∏ÄÏì∞Í∏∞ Î≤ÑÌäº Ïà®ÍπÄ", err);
            }
        });

        function toggleLike(button) {
            const bno = button.getAttribute('data-bno');
            const heartIcon = button.querySelector('.heart-icon');
            const countSpan = button.querySelector('.like-count');

            fetch('/board/like/${bno}' + bno, {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        countSpan.textContent = data.likeCount;
                        heartIcon.textContent = data.liked ? '‚ô•' : '‚ô°';
                    }
                })
                .catch(err => console.error(err));
        }
    </script>
</th:block>

</body>
</html>